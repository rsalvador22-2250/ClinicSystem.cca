<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clinic Records Dashboard | SASO System</title>
<link rel="icon" type="download-Photoroom" href="download-Photoroom.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
/* ===== CSS RESET & VARIABLES ===== */
:root {
    --primary: #2E7D32;
    --primary-light: #4CAF50;
    --primary-dark: #1B5E20;
    --secondary: #0288D1;
    --secondary-light: #03A9F4;
    --light-bg: #F5F9F6;
    --card-bg: #FFFFFF;
    --text: #2D3748;    
    --text-light: #718096;
    --border: #E2E8F0;
    --success: #10B981;
    --warning: #F59E0B;
    --error: #EF4444;
    --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
    --radius: 16px;
    --radius-sm: 10px;
    --transition: all 0.3s ease;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: #f5f9f5;
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
}

/* ===== HEADER ===== */
.header {
    background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    color: white;
    padding: 20px 30px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.header-logo {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    object-fit: cover;
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.header-title h1 {
    font-family: 'Poppins', sans-serif;
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.header-title p {
    font-size: 0.9rem;
    opacity: 0.9;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 15px;
}

/* ===== MAIN CONTAINER ===== */
.main-container {
    max-width: 1400px;
    margin: 30px auto;
    padding: 0 20px;
}

/* ===== DASHBOARD CARDS ===== */
.dashboard-cards {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 30px;
}

.dashboard-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 25px;
    box-shadow: var(--shadow);
    transition: var(--transition);
    border-left: 5px solid var(--primary);
}

.dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.card-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    background: rgba(46, 125, 50, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
}

.card-icon i {
    font-size: 1.8rem;
    color: var(--primary);
}

.card-value {
    font-size: 2.2rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 5px;
}

.card-label {
    font-size: 0.95rem;
    color: var(--text-light);
    font-weight: 500;
}

/* ===== CONTROLS BAR ===== */
.controls-bar {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.search-box {
    position: relative;
    flex: 1;
    max-width: 400px;
}

.search-box i {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
}

.search-box input {
    width: 100%;
    padding: 12px 15px 12px 45px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 1rem;
    font-family: 'Inter', sans-serif;
    transition: var(--transition);
}

.search-box input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.15);
}

.action-buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

/* ===== FILTER MODAL ===== */
.filter-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
    animation: fadeIn 0.3s ease;
}

.filter-content {
    background-color: white;
    border-radius: var(--radius);
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    animation: slideUp 0.3s ease;
}

.filter-header {
    background: linear-gradient(to right, var(--primary-dark), var(--primary));
    color: white;
    padding: 25px 30px;
    border-radius: var(--radius) var(--radius) 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.filter-header h3 {
    font-family: 'Poppins', sans-serif;
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.filter-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.8rem;
    cursor: pointer;
    line-height: 1;
    transition: var(--transition);
    padding: 5px;
    border-radius: 4px;
}

.filter-close:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.filter-body {
    padding: 30px;
}

.filter-form {
    display: grid;
    gap: 20px;
}

.filter-group {
    margin-bottom: 15px;
}

.filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text);
    font-size: 0.95rem;
}

.filter-group input,
.filter-group select {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 1rem;
    font-family: 'Inter', sans-serif;
    color: var(--text);
    background-color: white;
    transition: var(--transition);
}

.filter-group input:focus,
.filter-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.15);
}

.filter-footer {
    padding: 20px 30px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 15px;
}

/* ===== BUTTONS ===== */
.btn {
    padding: 12px 24px;
    border-radius: var(--radius-sm);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-family: 'Inter', sans-serif;
}

.btn-primary {
    background: linear-gradient(to right, var(--primary), var(--primary-light));
    color: white;
    box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
}

.btn-primary:hover {
    background: linear-gradient(to right, var(--primary-dark), var(--primary));
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(46, 125, 50, 0.4);
}

.btn-secondary {
    background-color: white;
    color: var(--secondary);
    border: 2px solid var(--secondary);
}

.btn-secondary:hover {
    background-color: var(--secondary);
    color: white;
    transform: translateY(-2px);
}

.btn-success {
    background: linear-gradient(to right, #10B981, #34D399);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-success:hover {
    background: linear-gradient(to right, #0DA271, #10B981);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
}

.btn-warning {
    background-color: white;
    color: var(--warning);
    border: 2px solid var(--warning);
}

.btn-warning:hover {
    background-color: var(--warning);
    color: white;
    transform: translateY(-2px);
}

.btn-logout {
    background-color: rgba(255, 255, 255, 0.15);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-logout:hover {
    background-color: rgba(255, 255, 255, 0.25);
}

/* ===== RECORDS TABLE ===== */
.records-container {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 25px;
    box-shadow: var(--shadow);
    overflow: hidden;
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border);
}

.table-header h2 {
    font-family: 'Poppins', sans-serif;
    font-size: 1.4rem;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.table-wrapper {
    overflow-x: auto;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
}

.records-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1000px;
}

.records-table thead {
    background: linear-gradient(to right, var(--primary-dark), var(--primary));
    color: white;
}

.records-table th {
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 0.95rem;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
}

.records-table th:last-child {
    border-right: none;
}

.records-table tbody tr {
    border-bottom: 1px solid var(--border);
    transition: var(--transition);
}

.records-table tbody tr:hover {
    background-color: rgba(46, 125, 50, 0.05);
}

.records-table td {
    padding: 14px 12px;
    vertical-align: top;
    font-size: 0.95rem;
}

.status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.badge-completed {
    background-color: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.badge-pending {
    background-color: rgba(245, 158, 11, 0.1);
    color: var(--warning);
}

/* ===== ACTION BUTTONS IN TABLE ===== */
.action-cell {
    white-space: nowrap;
}

.action-buttons-small {
    display: flex;
    gap: 8px;
}

.btn-small {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    border: none;
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-edit {
    background-color: rgba(2, 136, 209, 0.1);
    color: var(--secondary);
    border: 1px solid rgba(2, 136, 209, 0.2);
}

.btn-edit:hover {
    background-color: var(--secondary);
    color: white;
}

.btn-delete {
    background-color: rgba(239, 68, 68, 0.1);
    color: var(--error);
    border: 1px solid rgba(239, 68, 68, 0.2);
}

.btn-delete:hover {
    background-color: var(--error);
    color: white;
}

.btn-view {
    background-color: rgba(46, 125, 50, 0.1);
    color: var(--primary);
    border: 1px solid rgba(46, 125, 50, 0.2);
}

.btn-view:hover {
    background-color: var(--primary);
    color: white;
}

/* ===== MODAL ===== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background-color: white;
    border-radius: var(--radius);
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    background: linear-gradient(to right, var(--primary-dark), var(--primary));
    color: white;
    padding: 25px 30px;
    border-radius: var(--radius) var(--radius) 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    font-family: 'Poppins', sans-serif;
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.8rem;
    cursor: pointer;
    line-height: 1;
    transition: var(--transition);
    padding: 5px;
    border-radius: 4px;
}

.modal-close:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.modal-body {
    padding: 30px;
}

/* ===== VIEW MODAL STYLES ===== */
.record-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 25px;
}

.detail-card {
    background: var(--light-bg);
    border-radius: var(--radius-sm);
    padding: 20px;
    border-left: 4px solid var(--primary);
}

.detail-card.full-width {
    grid-column: span 2;
}

.detail-card h4 {
    font-family: 'Poppins', sans-serif;
    color: var(--primary);
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid rgba(46, 125, 50, 0.1);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.1rem;
}

.detail-item {
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.detail-item:last-child {
    margin-bottom: 0;
}

.detail-label {
    font-weight: 600;
    color: var(--text-light);
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.detail-label i {
    color: var(--primary);
    width: 16px;
    text-align: center;
}

.detail-value {
    color: var(--text);
    font-size: 1rem;
    padding-left: 24px;
    line-height: 1.5;
}

.detail-value.multiline {
    white-space: pre-line;
    background: white;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    margin-top: 5px;
}

.patient-info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}

.time-display {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}

.time-item {
    display: flex;
    align-items: center;
    gap: 8px;
    background: white;
    padding: 8px 15px;
    border-radius: 6px;
    border: 1px solid var(--border);
}

.time-item i {
    color: var(--primary);
}

/* ===== EDIT FORM ===== */
.edit-form {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group.full-width {
    grid-column: span 2;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text);
    font-size: 0.95rem;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 1rem;
    font-family: 'Inter', sans-serif;
    color: var(--text);
    background-color: white;
    transition: var(--transition);
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.15);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.modal-footer {
    padding: 20px 30px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 15px;
}

/* ===== LOADING STATE ===== */
.loading {
    text-align: center;
    padding: 50px;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.loading i {
    font-size: 2.5rem;
    color: var(--primary);
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.empty-state {
    text-align: center;
    padding: 50px;
    color: var(--text-light);
}

.empty-state i {
    font-size: 3rem;
    color: var(--border);
    margin-bottom: 15px;
}

/* ===== ACTIVE FILTER BADGE ===== */
.active-filter {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--light-bg);
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9rem;
    color: var(--primary);
    margin-left: 15px;
}

.active-filter .clear-filter {
    background: none;
    border: none;
    color: var(--error);
    cursor: pointer;
    font-size: 1rem;
    padding: 0;
    display: flex;
    align-items: center;
}

/* ===== PRINT STYLES ===== */
@media print {
    body * {
        visibility: hidden;
    }
    
    .modal-content,
    .modal-content * {
        visibility: visible;
    }
    
    .modal-content {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        max-width: 100%;
        box-shadow: none;
    }
    
    .modal-header, .modal-footer {
        display: none;
    }
    
    .record-details {
        display: block;
    }
    
    .detail-card {
        break-inside: avoid;
        margin-bottom: 20px;
    }
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 1024px) {
    .edit-form {
        grid-template-columns: 1fr;
    }
    
    .form-group.full-width {
        grid-column: span 1;
    }
    
    .record-details {
        grid-template-columns: 1fr;
    }
    
    .detail-card.full-width {
        grid-column: span 1;
    }
    
    .patient-info-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .header {
        flex-direction: column;
        gap: 15px;
        padding: 15px 20px;
        text-align: center;
    }
    
    .header-left, .header-right {
        width: 100%;
        justify-content: center;
    }
    
    .controls-bar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-box {
        max-width: 100%;
    }
    
    .action-buttons {
        justify-content: center;
    }
    
    .modal-body, .filter-body {
        padding: 20px;
    }
    
    .time-display {
        flex-direction: column;
        gap: 10px;
    }
    
    .dashboard-cards {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .main-container {
        padding: 0 15px;
    }
    
    .btn {
        padding: 10px 15px;
        font-size: 0.9rem;
    }
    
    .records-table th,
    .records-table td {
        padding: 10px 8px;
        font-size: 0.85rem;
    }
    
    .action-buttons-small {
        flex-direction: column;
        gap: 5px;
    }
    
    .btn-small {
        padding: 4px 8px;
        font-size: 0.8rem;
    }
}
</style>
</head>
<body>

<!-- Header -->
<header class="header">
    <div class="header-left">
        <img src="download-Photoroom.png" alt="Clinic Logo" class="header-logo">
        <div class="header-title">
            <h1>Clinic Records Dashboard</h1>
            <p>Manage and monitor student consultation records</p>
        </div>
    </div>
    <div class="header-right">
        <button id="newConsultationBtn" class="btn btn-success">
            <i class="fas fa-plus-circle"></i> New Consultation
        </button>
        <button id="logoutBtn" class="btn btn-logout">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>
</header>

<!-- Main Container -->
<div class="main-container">
    <!-- Dashboard Cards -->
    <div class="dashboard-cards">
        <div class="dashboard-card">
            <div class="card-icon">
                <i class="fas fa-file-medical-alt"></i>
            </div>
            <div class="card-value" id="totalRecords">0</div>
            <div class="card-label">Total Records</div>
        </div>
        <div class="dashboard-card">
            <div class="card-icon">
                <i class="fas fa-user-md"></i>
            </div>
            <div class="card-value" id="personnelCount">0</div>
            <div class="card-label">Active Personnel</div>
        </div>
    </div>

    <!-- Controls Bar -->
    <div class="controls-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search by name, student number, or section...">
        </div>
        <div class="action-buttons">
            <button id="exportBtn" class="btn btn-primary">
                <i class="fas fa-file-excel"></i> Export to Excel
            </button>
            <button id="filterBtn" class="btn btn-secondary">
                <i class="fas fa-filter"></i> Filter Records
            </button>
            <button id="refreshBtn" class="btn btn-secondary">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Active Filter Display -->
    <div id="activeFilterDisplay" style="display: none; margin-bottom: 15px;">
        <span class="active-filter">
            <i class="fas fa-filter"></i>
            <span id="filterText"></span>
            <button class="clear-filter" onclick="clearFilters()">
                <i class="fas fa-times"></i>
            </button>
        </span>
    </div>

    <!-- Records Table -->
    <div class="records-container">
        <div class="table-header">
            <h2><i class="fas fa-list-alt"></i> Consultation Records</h2>
            <div class="table-info">
                Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> records
            </div>
        </div>
        
        <div id="recordsContainer" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Loading records...</p>
        </div>
        
        <div class="table-wrapper" id="tableWrapper" style="display: none;">
            <table class="records-table" id="recordsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Student Info</th>
                        <th>Complaints</th>
                        <th>Assessment</th>
                        <th>Treatment</th>
                        <th>Personnel</th>
                        <th>Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Records will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div id="filterModal" class="filter-modal">
    <div class="filter-content">
        <div class="filter-header">
            <h3><i class="fas fa-filter"></i> Filter Records</h3>
            <button class="filter-close" id="filterClose">&times;</button>
        </div>
        <div class="filter-body">
            <form id="filterForm" class="filter-form">
                <div class="filter-group">
                    <label for="filterDate">Date</label>
                    <input type="date" id="filterDate">
                </div>
                <div class="filter-group">
                    <label for="filterPersonnel">Clinic Personnel</label>
                    <select id="filterPersonnel">
                        <option value="">All Personnel</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterSection">Section/Office</label>
                    <input type="text" id="filterSection" placeholder="e.g., BSIT 3-1">
                </div>
                <div class="filter-group">
                    <label for="filterDateRange">Date Range</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="filterStartDate" placeholder="Start Date" style="flex: 1;">
                        <span>to</span>
                        <input type="date" id="filterEndDate" placeholder="End Date" style="flex: 1;">
                    </div>
                </div>
            </form>
        </div>
        <div class="filter-footer">
            <button id="cancelFilterBtn" class="btn btn-secondary">Cancel</button>
            <button id="applyFilterBtn" class="btn btn-primary">
                <i class="fas fa-check"></i> Apply Filter
            </button>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit Consultation Record</h3>
            <button class="modal-close" id="modalClose">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editForm" class="edit-form">
                <div class="form-group">
                    <label for="editName">Student Name</label>
                    <input type="text" id="editName" placeholder="Enter full name" required>
                </div>
                <div class="form-group">
                    <label for="editStudentNumber">Student Number</label>
                    <input type="text" id="editStudentNumber" placeholder="Enter student number" required>
                </div>
                <div class="form-group">
                    <label for="editSection">Section/Office</label>
                    <input type="text" id="editSection" placeholder="e.g., BSIT 3-1, Faculty Office" required>
                </div>
                <div class="form-group">
                    <label for="editDate">Date</label>
                    <input type="date" id="editDate" required>
                </div>
                <div class="form-group">
                    <label for="editTimeIn">Time In</label>
                    <input type="time" id="editTimeIn" required>
                </div>
                <div class="form-group">
                    <label for="editTimeOut">Time Out</label>
                    <input type="time" id="editTimeOut">
                </div>
                <div class="form-group full-width">
                    <label for="editComplaints">Chief Complaints</label>
                    <textarea id="editComplaints" placeholder="Describe the patient's main complaints..." required></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="editAssessment">Assessment</label>
                    <textarea id="editAssessment" placeholder="Medical assessment findings..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="editMedicine">Medicine/Treatment</label>
                    <textarea id="editMedicine" placeholder="Medicine or treatment given..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="editIntervention">Intervention</label>
                    <textarea id="editIntervention" placeholder="Intervention provided..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="editPersonnel">Clinic Personnel</label>
                    <input type="text" id="editPersonnel" placeholder="Name of attending personnel" required>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button id="cancelEditBtn" class="btn btn-secondary">Cancel</button>
            <button id="saveEditBtn" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </div>
</div>

<!-- View Modal -->
<div id="viewModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3><i class="fas fa-eye"></i> View Consultation Record</h3>
            <button class="modal-close" id="viewModalClose">&times;</button>
        </div>
        <div class="modal-body">
            <div class="record-details" id="recordDetails">
                <!-- Record details will be inserted here -->
            </div>
        </div>
        <div class="modal-footer">
            <button id="printRecordBtn" class="btn btn-primary">
                <i class="fas fa-print"></i> Print Record
            </button>
            <button id="closeViewBtn" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBhft3v9j2ooODFwL1GiBs97PvCCFuDo6U",
  authDomain: "clinicsystem-66175.firebaseapp.com",
  projectId: "clinicsystem-66175",
  storageBucket: "clinicsystem-66175.appspot.com",
  messagingSenderId: "572979094042",
  appId: "1:572979094042:web:2026805fab9c63930ae7a3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM Elements
const recordsContainer = document.getElementById("recordsContainer");
const tableWrapper = document.getElementById("tableWrapper");
const tableBody = document.getElementById("tableBody");
const searchInput = document.getElementById("searchInput");
const logoutBtn = document.getElementById("logoutBtn");
const newConsultationBtn = document.getElementById("newConsultationBtn");
const exportBtn = document.getElementById("exportBtn");
const filterBtn = document.getElementById("filterBtn");
const refreshBtn = document.getElementById("refreshBtn");
const editModal = document.getElementById("editModal");
const modalClose = document.getElementById("modalClose");
const saveEditBtn = document.getElementById("saveEditBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const filterModal = document.getElementById("filterModal");
const filterClose = document.getElementById("filterClose");
const cancelFilterBtn = document.getElementById("cancelFilterBtn");
const applyFilterBtn = document.getElementById("applyFilterBtn");
const activeFilterDisplay = document.getElementById("activeFilterDisplay");
const filterText = document.getElementById("filterText");
const viewModal = document.getElementById("viewModal");
const viewModalClose = document.getElementById("viewModalClose");
const closeViewBtn = document.getElementById("closeViewBtn");
const printRecordBtn = document.getElementById("printRecordBtn");
const recordDetails = document.getElementById("recordDetails");

// Filter Elements
const filterDate = document.getElementById("filterDate");
const filterPersonnel = document.getElementById("filterPersonnel");
const filterSection = document.getElementById("filterSection");
const filterStartDate = document.getElementById("filterStartDate");
const filterEndDate = document.getElementById("filterEndDate");

// Stats Elements
const totalRecordsEl = document.getElementById("totalRecords");
const personnelCountEl = document.getElementById("personnelCount");
const showingCountEl = document.getElementById("showingCount");
const totalCountEl = document.getElementById("totalCount");

let allRecords = [];
let filteredRecords = [];
let editingRecordId = null;
let viewingRecordId = null;
let activeFilters = {
    date: null,
    personnel: null,
    section: null,
    startDate: null,
    endDate: null
};

// ===== AUTHENTICATION CHECK - PROTECT PAGE =====
onAuthStateChanged(auth, user => {
  if (!user) {
    // If no user is logged in, redirect to login page
    window.location.href = "login.html";
  } else {
    // User is logged in, load the records
    loadRecords();
    updateDashboardStats();
  }
});

// Logout function
logoutBtn.addEventListener("click", async () => {
  try {
    await signOut(auth);
    window.location.href = "login.html";
  } catch (error) {
    console.error("Error signing out:", error);
    showMessage("Error signing out. Please try again.", "error");
  }
});

// New Consultation button
newConsultationBtn.addEventListener("click", () => {
  window.location.href = "index.html";
});

// Refresh button
refreshBtn.addEventListener("click", () => {
  loadRecords();
  updateDashboardStats();
  showMessage("Records refreshed successfully!", "success");
});

// Filter button
filterBtn.addEventListener("click", () => {
  openFilterModal();
});

// Close filter modal
filterClose.addEventListener("click", closeFilterModal);
cancelFilterBtn.addEventListener("click", closeFilterModal);
filterModal.addEventListener("click", e => {
  if (e.target === filterModal) closeFilterModal();
});

// Apply filter
applyFilterBtn.addEventListener("click", () => {
  applyFilters();
  closeFilterModal();
});

// Open filter modal
function openFilterModal() {
  // Set today's date as default for date filter
  const today = new Date().toISOString().split('T')[0];
  filterDate.value = today;
  
  // Populate personnel dropdown
  populatePersonnelFilter();
  
  // Set current filter values if any
  if (activeFilters.date) filterDate.value = activeFilters.date;
  if (activeFilters.personnel) filterPersonnel.value = activeFilters.personnel;
  if (activeFilters.section) filterSection.value = activeFilters.section;
  if (activeFilters.startDate) filterStartDate.value = activeFilters.startDate;
  if (activeFilters.endDate) filterEndDate.value = activeFilters.endDate;
  
  filterModal.style.display = "flex";
}

// Close filter modal
function closeFilterModal() {
  filterModal.style.display = "none";
}

// Populate personnel filter dropdown
function populatePersonnelFilter() {
  const personnelSet = new Set(allRecords.map(r => r.personnel).filter(Boolean));
  filterPersonnel.innerHTML = '<option value="">All Personnel</option>';
  
  personnelSet.forEach(personnel => {
    const option = document.createElement('option');
    option.value = personnel;
    option.textContent = personnel;
    filterPersonnel.appendChild(option);
  });
}

// Apply filters
function applyFilters() {
  // Get filter values
  activeFilters.date = filterDate.value || null;
  activeFilters.personnel = filterPersonnel.value || null;
  activeFilters.section = filterSection.value || null;
  activeFilters.startDate = filterStartDate.value || null;
  activeFilters.endDate = filterEndDate.value || null;
  
  // Apply filters to records
  applyFiltersToRecords();
  
  // Update filter display
  updateFilterDisplay();
}

// Apply filters to records
function applyFiltersToRecords() {
  filteredRecords = allRecords.filter(record => {
    // Date filter
    if (activeFilters.date && record.date !== activeFilters.date) {
      return false;
    }
    
    // Personnel filter
    if (activeFilters.personnel && record.personnel !== activeFilters.personnel) {
      return false;
    }
    
    // Section filter (partial match)
    if (activeFilters.section && !record.section?.toLowerCase().includes(activeFilters.section.toLowerCase())) {
      return false;
    }
    
    // Date range filter
    if (activeFilters.startDate && activeFilters.endDate) {
      const recordDate = new Date(record.date);
      const startDate = new Date(activeFilters.startDate);
      const endDate = new Date(activeFilters.endDate);
      
      if (recordDate < startDate || recordDate > endDate) {
        return false;
      }
    }
    
    return true;
  });
  
  renderRecords();
}

// Update filter display
function updateFilterDisplay() {
  const filters = [];
  
  if (activeFilters.date) filters.push(`Date: ${activeFilters.date}`);
  if (activeFilters.personnel) filters.push(`Personnel: ${activeFilters.personnel}`);
  if (activeFilters.section) filters.push(`Section: ${activeFilters.section}`);
  if (activeFilters.startDate && activeFilters.endDate) {
    filters.push(`Date Range: ${activeFilters.startDate} to ${activeFilters.endDate}`);
  }
  
  if (filters.length > 0) {
    filterText.textContent = filters.join(', ');
    activeFilterDisplay.style.display = 'block';
  } else {
    activeFilterDisplay.style.display = 'none';
  }
}

// Clear all filters
window.clearFilters = function() {
  activeFilters = {
    date: null,
    personnel: null,
    section: null,
    startDate: null,
    endDate: null
  };
  
  filterDate.value = '';
  filterPersonnel.value = '';
  filterSection.value = '';
  filterStartDate.value = '';
  filterEndDate.value = '';
  
  filteredRecords = [...allRecords];
  renderRecords();
  activeFilterDisplay.style.display = 'none';
  showMessage("Filters cleared", "success");
};

// Load Firestore records
function loadRecords() {
  recordsContainer.className = "loading";
  recordsContainer.innerHTML = '<i class="fas fa-spinner"></i><p>Loading records...</p>';
  tableWrapper.style.display = "none";
  
  const q = query(collection(db, "clinicform"), orderBy("timestamp", "desc"));
  onSnapshot(q, snapshot => {
    allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    filteredRecords = [...allRecords];
    applyFiltersToRecords(); // Apply any existing filters
    updateDashboardStats();
  });
}

// Render records table
function renderRecords() {
  if (filteredRecords.length === 0) {
    recordsContainer.className = "empty-state";
    recordsContainer.innerHTML = `
      <i class="fas fa-clipboard-list"></i>
      <h3>No records found</h3>
      <p>${allRecords.length === 0 ? 'No records in database.' : 'Try adjusting your search or filters.'}</p>
    `;
    tableWrapper.style.display = "none";
    return;
  }
  
  recordsContainer.style.display = "none";
  tableWrapper.style.display = "block";
  
  let html = "";
  filteredRecords.forEach(record => {
    const timeDisplay = `${record.time_in || ""}${record.time_out ? ` - ${record.time_out}` : ""}`;
    
    html += `
      <tr>
        <td>
          <div class="date-display">${formatDate(record.date)}</div>
          <div class="badge-completed status-badge">Completed</div>
        </td>
        <td>
          <strong>${record.name || ""}</strong><br>
          <small>${record.student_number || ""}</small><br>
          <small>${record.section || ""}</small>
        </td>
        <td>${truncateText(record.complaints, 60)}</td>
        <td>${truncateText(record.assessment, 60)}</td>
        <td>
          <strong>Medicine:</strong> ${truncateText(record.medicine, 30)}<br>
          <strong>Intervention:</strong> ${truncateText(record.intervention, 30)}
        </td>
        <td>${record.personnel || ""}</td>
        <td>${timeDisplay}</td>
        <td class="action-cell">
          <div class="action-buttons-small">
            <button class="btn-small btn-view" data-id="${record.id}">
              <i class="fas fa-eye"></i> View
            </button>
            <button class="btn-small btn-edit" data-id="${record.id}">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn-small btn-delete" data-id="${record.id}">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </td>
      </tr>
    `;
  });
  
  tableBody.innerHTML = html;
  
  // Update counts
  showingCountEl.textContent = filteredRecords.length;
  totalCountEl.textContent = allRecords.length;
  
  // Add event listeners to buttons
  document.querySelectorAll(".btn-delete").forEach(btn => {
    btn.onclick = () => deleteRecord(btn.dataset.id);
  });
  
  document.querySelectorAll(".btn-edit").forEach(btn => {
    btn.onclick = () => openEditModal(btn.dataset.id);
  });
  
  document.querySelectorAll(".btn-view").forEach(btn => {
    btn.onclick = () => openViewModal(btn.dataset.id);
  });
}

// Delete record
async function deleteRecord(id) {
  if (!confirm("Are you sure you want to delete this record? This action cannot be undone.")) return;
  
  try {
    await deleteDoc(doc(db, "clinicform", id));
    showMessage("Record deleted successfully!", "success");
  } catch (error) {
    console.error("Error deleting record:", error);
    showMessage("Failed to delete record. Please try again.", "error");
  }
}

// Open edit modal
function openEditModal(id) {
  const record = allRecords.find(r => r.id === id);
  if (!record) return;
  
  editingRecordId = id;
  
  // Populate form fields
  document.getElementById("editName").value = record.name || "";
  document.getElementById("editStudentNumber").value = record.student_number || "";
  document.getElementById("editSection").value = record.section || "";
  document.getElementById("editDate").value = record.date || "";
  document.getElementById("editTimeIn").value = record.time_in || "";
  document.getElementById("editTimeOut").value = record.time_out || "";
  document.getElementById("editComplaints").value = record.complaints || "";
  document.getElementById("editAssessment").value = record.assessment || "";
  document.getElementById("editMedicine").value = record.medicine || "";
  document.getElementById("editIntervention").value = record.intervention || "";
  document.getElementById("editPersonnel").value = record.personnel || "";
  
  editModal.style.display = "flex";
}

// Open view modal
function openViewModal(id) {
  const record = allRecords.find(r => r.id === id);
  if (!record) return;
  
  viewingRecordId = id;
  
  // Format the date for display
  const displayDate = record.date ? formatDate(record.date) : 'Not specified';
  
  // Create HTML for the view modal
  const html = `
    <div class="detail-card">
      <h4><i class="fas fa-user-injured"></i> Patient Information</h4>
      <div class="patient-info-grid">
        <div class="detail-item">
          <div class="detail-label"><i class="fas fa-user"></i> Full Name</div>
          <div class="detail-value">${record.name || 'Not specified'}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label"><i class="fas fa-id-card"></i> Student Number</div>
          <div class="detail-value">${record.student_number || 'Not specified'}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label"><i class="fas fa-building"></i> Section/Office</div>
          <div class="detail-value">${record.section || 'Not specified'}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label"><i class="fas fa-calendar-day"></i> Date</div>
          <div class="detail-value">${displayDate}</div>
        </div>
      </div>
      <div class="detail-item">
        <div class="detail-label"><i class="fas fa-clock"></i> Time</div>
        <div class="time-display">
          <div class="time-item">
            <i class="fas fa-sign-in-alt"></i>
            <span>Time In: ${record.time_in || 'Not specified'}</span>
          </div>
          <div class="time-item">
            <i class="fas fa-sign-out-alt"></i>
            <span>Time Out: ${record.time_out || 'Not specified'}</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="detail-card">
      <h4><i class="fas fa-stethoscope"></i> Chief Complaints</h4>
      <div class="detail-item">
        <div class="detail-value multiline">${record.complaints || 'No complaints recorded'}</div>
      </div>
    </div>
    
    <div class="detail-card">
      <h4><i class="fas fa-clipboard-check"></i> Medical Assessment</h4>
      <div class="detail-item">
        <div class="detail-value multiline">${record.assessment || 'No assessment recorded'}</div>
      </div>
    </div>
    
    <div class="detail-card">
      <h4><i class="fas fa-pills"></i> Treatment Provided</h4>
      <div class="detail-item">
        <div class="detail-label"><i class="fas fa-capsules"></i> Medicine/Treatment</div>
        <div class="detail-value multiline">${record.medicine || 'No medicine/treatment recorded'}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label"><i class="fas fa-hands-helping"></i> Intervention</div>
        <div class="detail-value multiline">${record.intervention || 'No intervention recorded'}</div>
      </div>
    </div>
    
    <div class="detail-card">
      <h4><i class="fas fa-user-md"></i> Clinic Personnel</h4>
      <div class="detail-item">
        <div class="detail-label"><i class="fas fa-user-nurse"></i> Attending Personnel</div>
        <div class="detail-value">${record.personnel || 'Not specified'}</div>
      </div>
    </div>
  `;
  
  recordDetails.innerHTML = html;
  viewModal.style.display = "flex";
}

// Save edits
saveEditBtn.onclick = async () => {
  const data = {
    name: document.getElementById("editName").value,
    student_number: document.getElementById("editStudentNumber").value,
    section: document.getElementById("editSection").value,
    date: document.getElementById("editDate").value,
    time_in: document.getElementById("editTimeIn").value,
    time_out: document.getElementById("editTimeOut").value,
    complaints: document.getElementById("editComplaints").value,
    assessment: document.getElementById("editAssessment").value,
    medicine: document.getElementById("editMedicine").value,
    intervention: document.getElementById("editIntervention").value,
    personnel: document.getElementById("editPersonnel").value
  };
  
  try {
    await updateDoc(doc(db, "clinicform", editingRecordId), data);
    showMessage("Record updated successfully!", "success");
    closeModal();
  } catch (error) {
    console.error("Error updating record:", error);
    showMessage("Failed to update record. Please try again.", "error");
  }
};

// Close edit modal
function closeModal() {
  editModal.style.display = "none";
}

cancelEditBtn.onclick = closeModal;
modalClose.onclick = closeModal;
editModal.onclick = e => {
  if (e.target === editModal) closeModal();
};

// Close view modal
function closeViewModal() {
  viewModal.style.display = "none";
}

viewModalClose.onclick = closeViewModal;
closeViewBtn.onclick = closeViewModal;
viewModal.onclick = e => {
  if (e.target === viewModal) closeViewModal();
};

// Print record
printRecordBtn.onclick = () => {
  window.print();
};

// Search filter
searchInput.addEventListener("input", () => {
  const term = searchInput.value.toLowerCase().trim();
  
  if (!term) {
    // If search is empty, apply only active filters
    applyFiltersToRecords();
  } else {
    // Apply search term on top of active filters
    let tempRecords = [...allRecords];
    
    // First apply active filters
    if (Object.values(activeFilters).some(filter => filter !== null)) {
      tempRecords = applyFiltersToArray(tempRecords);
    }
    
    // Then apply search
    filteredRecords = tempRecords.filter(record => {
      return (
        (record.name && record.name.toLowerCase().includes(term)) ||
        (record.student_number && record.student_number.toLowerCase().includes(term)) ||
        (record.section && record.section.toLowerCase().includes(term)) ||
        (record.complaints && record.complaints.toLowerCase().includes(term)) ||
        (record.personnel && record.personnel.toLowerCase().includes(term))
      );
    });
    
    renderRecords();
  }
});

// Helper function to apply filters to array
function applyFiltersToArray(records) {
  return records.filter(record => {
    if (activeFilters.date && record.date !== activeFilters.date) {
      return false;
    }
    if (activeFilters.personnel && record.personnel !== activeFilters.personnel) {
      return false;
    }
    if (activeFilters.section && !record.section?.toLowerCase().includes(activeFilters.section.toLowerCase())) {
      return false;
    }
    if (activeFilters.startDate && activeFilters.endDate) {
      const recordDate = new Date(record.date);
      const startDate = new Date(activeFilters.startDate);
      const endDate = new Date(activeFilters.endDate);
      
      if (recordDate < startDate || recordDate > endDate) {
        return false;
      }
    }
    return true;
  });
}

// Export to Excel
exportBtn.addEventListener("click", () => {
  if (filteredRecords.length === 0) {
    showMessage("No records to export!", "error");
    return;
  }

  const data = filteredRecords.map(r => ({
    Date: r.date || "",
    Name: r.name || "",
    "Student Number": r.student_number || "",
    Section: r.section || "",
    "Time In": r.time_in || "",
    "Time Out": r.time_out || "",
    Complaints: r.complaints || "",
    Assessment: r.assessment || "",
    Medicine: r.medicine || "",
    Intervention: r.intervention || "",
    Personnel: r.personnel || ""
  }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Clinic Records");
  
  const date = new Date().toISOString().split('T')[0];
  XLSX.writeFile(wb, `ClinicRecords_${date}.xlsx`);
  
  showMessage("Export completed successfully!", "success");
});

// Update dashboard statistics
async function updateDashboardStats() {
  // Total records
  totalRecordsEl.textContent = allRecords.length;
  
  // Unique personnel count
  const personnelSet = new Set(allRecords.map(r => r.personnel).filter(Boolean));
  personnelCountEl.textContent = personnelSet.size;
}

// Helper functions
function formatDate(dateString) {
  if (!dateString) return "";
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { 
    weekday: 'long',
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
}

function truncateText(text, maxLength) {
  if (!text) return "";
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + "...";
}

function showMessage(message, type = "info") {
  // Create temporary message element
  const messageEl = document.createElement("div");
  messageEl.className = `message-${type}`;
  messageEl.textContent = message;
  messageEl.style.cssText = `
    position: fixed;
    top: 100px;
    right: 20px;
    padding: 15px 20px;
    border-radius: var(--radius-sm);
    background-color: ${type === "success" ? "#10B981" : type === "error" ? "#EF4444" : "#0288D1"};
    color: white;
    font-weight: 500;
    z-index: 1000;
    box-shadow: var(--shadow);
    animation: slideInRight 0.3s ease;
  `;
  
  document.body.appendChild(messageEl);
  
  setTimeout(() => {
    messageEl.style.animation = "slideOutRight 0.3s ease";
    setTimeout(() => document.body.removeChild(messageEl), 300);
  }, 3000);
  
  // Add CSS for animations
  if (!document.getElementById('message-styles')) {
    const styleEl = document.createElement('style');
    styleEl.id = 'message-styles';
    styleEl.textContent = `
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(styleEl);
  }
}
</script>

</body>
</html>